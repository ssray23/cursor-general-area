# E-Commerce Checkout Architecture

## Overview
This document outlines a secure checkout architecture with real-time price/availability validation, PCI compliance, and payment processing through providers like Adyen.

---

## 1. High-Level Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            CUSTOMER BROWSER                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Product Page  â”‚â†’ â”‚  Shopping Cart  â”‚â†’ â”‚   Checkout Page        â”‚   â”‚
â”‚  â”‚  (Search/View) â”‚  â”‚  (Add to Cart)  â”‚  â”‚  (Payment Collection)  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                      â†“                         â†“
         â”‚                      â”‚                         â”‚
         â”‚                      â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        YOUR APPLICATION SERVER                           â”‚
â”‚                           (PCI Scope: Minimal)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  API Layer                                                       â”‚   â”‚
â”‚  â”‚  â€¢ Product Search                                                â”‚   â”‚
â”‚  â”‚  â€¢ Cart Management                                               â”‚   â”‚
â”‚  â”‚  â€¢ âœ“ Pre-Payment Validation (Price + Inventory Check)           â”‚   â”‚
â”‚  â”‚  â€¢ Order Creation                                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Database                                                        â”‚   â”‚
â”‚  â”‚  â€¢ Products (SKU, price, inventory)                              â”‚   â”‚
â”‚  â”‚  â€¢ Shopping Carts                                                â”‚   â”‚
â”‚  â”‚  â€¢ Orders                                                        â”‚   â”‚
â”‚  â”‚  â€¢ âœ“ Payment Tokens (NOT card numbers)                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚                         â”‚
                         â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   INVENTORY/PRICING SYSTEM          â”‚   â”‚  PAYMENT PROCESSOR           â”‚
â”‚   (Real-time availability)          â”‚   â”‚  (Adyen, Stripe, etc.)       â”‚
â”‚                                     â”‚   â”‚  (PCI Scope: Full)            â”‚
â”‚  â€¢ Current stock levels             â”‚   â”‚                               â”‚
â”‚  â€¢ Dynamic pricing                  â”‚   â”‚  â€¢ Tokenization               â”‚
â”‚  â€¢ Reservation system               â”‚   â”‚  â€¢ Card data encryption       â”‚
â”‚  â€¢ Price rules engine               â”‚   â”‚  â€¢ Payment authorization      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â€¢ Settlement                 â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                           â”‚  CARD NETWORKS                 â”‚
                                           â”‚  (Visa, Mastercard, etc.)      â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                           â”‚  ISSUING BANK                  â”‚
                                           â”‚  (Customer's Bank)             â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Checkout Flow with Last-Minute Validation

### Step-by-Step Flow

```
PHASE 1: Shopping (Long Lead Time)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Time: T-0 (Start)                                                â”‚
â”‚ User searches â†’ Views product â†’ Adds to cart                     â”‚
â”‚ Note: Price was $100, Stock was 50 units                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
         â±ï¸ Time passes... (minutes, hours, or days)
         â†“
         
PHASE 2: Checkout Initiation
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Time: T-30 (30 minutes later)                                    â”‚
â”‚ User clicks "Proceed to Checkout"                                â”‚
â”‚                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ CRITICAL: First Validation Point                           â”‚  â”‚
â”‚ â”‚ API Call: POST /api/checkout/validate                      â”‚  â”‚
â”‚ â”‚                                                             â”‚  â”‚
â”‚ â”‚ Request Body:                                               â”‚  â”‚
â”‚ â”‚ {                                                           â”‚  â”‚
â”‚ â”‚   "cart_id": "cart_123",                                    â”‚  â”‚
â”‚ â”‚   "items": [                                                â”‚  â”‚
â”‚ â”‚     {"sku": "PROD-001", "quantity": 2, "price": 100}       â”‚  â”‚
â”‚ â”‚   ]                                                         â”‚  â”‚
â”‚ â”‚ }                                                           â”‚  â”‚
â”‚ â”‚                                                             â”‚  â”‚
â”‚ â”‚ Backend Checks:                                             â”‚  â”‚
â”‚ â”‚ âœ“ Current price: Still $100? Or jumped to $120?           â”‚  â”‚
â”‚ â”‚ âœ“ Availability: Still 50 units? Or sold out?               â”‚  â”‚
â”‚ â”‚ âœ“ Cart validity: Not expired                               â”‚  â”‚
â”‚ â”‚                                                             â”‚  â”‚
â”‚ â”‚ Response Scenarios:                                         â”‚  â”‚
â”‚ â”‚                                                             â”‚  â”‚
â”‚ â”‚ âœ… Success (200):                                           â”‚  â”‚
â”‚ â”‚ {                                                           â”‚  â”‚
â”‚ â”‚   "valid": true,                                            â”‚  â”‚
â”‚ â”‚   "total": 200,                                             â”‚  â”‚
â”‚ â”‚   "reserved_until": "2025-11-12T10:45:00Z"                 â”‚  â”‚
â”‚ â”‚ }                                                           â”‚  â”‚
â”‚ â”‚                                                             â”‚  â”‚
â”‚ â”‚ âš ï¸ Price Change (200):                                      â”‚  â”‚
â”‚ â”‚ {                                                           â”‚  â”‚
â”‚ â”‚   "valid": false,                                           â”‚  â”‚
â”‚ â”‚   "reason": "price_changed",                                â”‚  â”‚
â”‚ â”‚   "items": [                                                â”‚  â”‚
â”‚ â”‚     {                                                       â”‚  â”‚
â”‚ â”‚       "sku": "PROD-001",                                    â”‚  â”‚
â”‚ â”‚       "old_price": 100,                                     â”‚  â”‚
â”‚ â”‚       "new_price": 120,                                     â”‚  â”‚
â”‚ â”‚       "available": true                                     â”‚  â”‚
â”‚ â”‚     }                                                       â”‚  â”‚
â”‚ â”‚   ],                                                        â”‚  â”‚
â”‚ â”‚   "new_total": 240                                          â”‚  â”‚
â”‚ â”‚ }                                                           â”‚  â”‚
â”‚ â”‚                                                             â”‚  â”‚
â”‚ â”‚ âŒ Out of Stock (200):                                      â”‚  â”‚
â”‚ â”‚ {                                                           â”‚  â”‚
â”‚ â”‚   "valid": false,                                           â”‚  â”‚
â”‚ â”‚   "reason": "insufficient_inventory",                       â”‚  â”‚
â”‚ â”‚   "items": [                                                â”‚  â”‚
â”‚ â”‚     {                                                       â”‚  â”‚
â”‚ â”‚       "sku": "PROD-001",                                    â”‚  â”‚
â”‚ â”‚       "requested": 2,                                       â”‚  â”‚
â”‚ â”‚       "available": 0                                        â”‚  â”‚
â”‚ â”‚     }                                                       â”‚  â”‚
â”‚ â”‚   ]                                                         â”‚  â”‚
â”‚ â”‚ }                                                           â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
         
PHASE 3: User Reviews & Enters Payment Info
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User sees order summary with validated price                     â”‚
â”‚ Inventory is temporarily RESERVED (10-15 min hold)               â”‚
â”‚ User fills in shipping address                                   â”‚
â”‚ User enters payment information                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
         
PHASE 4: Payment Submission (Final Validation)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User clicks "Place Order"                                        â”‚
â”‚                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ CRITICAL: Second Validation Point                          â”‚  â”‚
â”‚ â”‚ API Call: POST /api/orders/create                          â”‚  â”‚
â”‚ â”‚                                                             â”‚  â”‚
â”‚ â”‚ Backend Re-checks (ATOMIC TRANSACTION):                     â”‚  â”‚
â”‚ â”‚ 1. âœ“ Validate price again (prevent race conditions)       â”‚  â”‚
â”‚ â”‚ 2. âœ“ Check inventory again (final confirmation)           â”‚  â”‚
â”‚ â”‚ 3. âœ“ Verify reservation is still valid                    â”‚  â”‚
â”‚ â”‚ 4. âœ“ Decrement inventory (commit stock)                   â”‚  â”‚
â”‚ â”‚ 5. â†’ Proceed to payment processing                         â”‚  â”‚
â”‚ â”‚                                                             â”‚  â”‚
â”‚ â”‚ If validation fails at this point:                         â”‚  â”‚
â”‚ â”‚ â†’ Abort transaction                                        â”‚  â”‚
â”‚ â”‚ â†’ Return error to user                                     â”‚  â”‚
â”‚ â”‚ â†’ Release any reservations                                 â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
         
PHASE 5: Payment Processing
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Payment details sent to Adyen (via token)                        â”‚
â”‚ Card authorization requested                                     â”‚
â”‚ Funds captured from customer                                     â”‚
â”‚ Order confirmed                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Payment Flow with PCI Compliance

### 3.1 Payment Collection (Frontend)

```html
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CHECKOUT PAGE (Browser)                       â”‚
â”‚                                                                    â”‚
â”‚  Order Summary: $240.00                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Payment Information                                       â”‚    â”‚
â”‚  â”‚                                                           â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  Card Number: [____-____-____-____]                â”‚  â”‚ â†â”€â”€â”¼â”€â”
â”‚  â”‚  â”‚  Expiry:      [__/__]   CVV: [___]                 â”‚  â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  Name:        [_____________________]              â”‚  â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚ â”‚
â”‚  â”‚         â†‘                                                 â”‚    â”‚ â”‚
â”‚  â”‚         â”‚ This is an IFRAME or Web Component             â”‚    â”‚ â”‚
â”‚  â”‚         â”‚ served by Adyen (NOT your server)              â”‚    â”‚ â”‚
â”‚  â”‚         â”‚ âœ… PCI-compliant hosted fields                 â”‚    â”‚ â”‚
â”‚  â”‚                                                           â”‚    â”‚ â”‚
â”‚  â”‚  [Place Order]  â† Button on YOUR page                    â”‚    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚                                                                    â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                                                       â”‚
  Card data NEVER touches your server! â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  It goes directly from browser â†’ Adyen via encrypted connection
```

### 3.2 Detailed Payment Processing Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Customer   â”‚
â”‚   Browser    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. User enters card details in Adyen's iframe/component
       â”‚
       â”‚ 2. Clicks "Place Order"
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  YOUR FRONTEND (JavaScript)                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  adyen.submit() // Adyen SDK handles card data                  â”‚
â”‚       â†“                                                          â”‚
â”‚       â”‚ Card data goes DIRECTLY to Adyen (not through you)      â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                                     â†“                            â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚                        â”‚   Adyen API             â”‚              â”‚
â”‚                        â”‚   (PCI-compliant vault) â”‚              â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                   â”‚                             â”‚
â”‚                                   â”‚ 3. Returns payment token    â”‚
â”‚                                   â†“                             â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚       â”‚ Response: {                            â”‚                â”‚
â”‚       â”‚   "token": "tok_abc123xyz",           â”‚                â”‚
â”‚       â”‚   "card_summary": "â€¢â€¢â€¢â€¢ 1234",        â”‚                â”‚
â”‚       â”‚   "brand": "visa"                     â”‚                â”‚
â”‚       â”‚ }                                     â”‚                â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                       â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ 4. Send token to your backend
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  YOUR BACKEND API                                               â”‚
â”‚  (PCI Scope: Minimal - only handles tokens)                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  POST /api/orders/create                                       â”‚
â”‚  {                                                              â”‚
â”‚    "cart_id": "cart_123",                                      â”‚
â”‚    "payment_token": "tok_abc123xyz",  â† Safe to store         â”‚
â”‚    "amount": 240.00,                                           â”‚
â”‚    "currency": "USD"                                           â”‚
â”‚  }                                                              â”‚
â”‚                                                                 â”‚
â”‚  Backend Process:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Validate cart & check inventory (FINAL check)         â”‚ â”‚
â”‚  â”‚ 2. Create order record in DB                             â”‚ â”‚
â”‚  â”‚ 3. Call Adyen to authorize payment                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                        â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ 5. Authorize payment
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ADYEN PAYMENT PROCESSOR                                        â”‚
â”‚  (PCI DSS Level 1 Certified)                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  POST /payments                                                â”‚
â”‚  {                                                              â”‚
â”‚    "amount": {"value": 24000, "currency": "USD"},             â”‚
â”‚    "reference": "order_456",                                   â”‚
â”‚    "paymentMethod": {"type": "scheme",                        â”‚
â”‚                      "encryptedCardNumber": "...",            â”‚
â”‚                      "encryptedExpiryMonth": "...",           â”‚
â”‚                      "encryptedExpiryYear": "...",            â”‚
â”‚                      "encryptedSecurityCode": "..."},         â”‚
â”‚    "merchantAccount": "YourMerchantAccount"                   â”‚
â”‚  }                                                              â”‚
â”‚                                                                 â”‚
â”‚  Adyen Process:                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Decrypt card details (in secure vault)               â”‚ â”‚
â”‚  â”‚ 2. Validate card data                                   â”‚ â”‚
â”‚  â”‚ 3. Route to appropriate card network                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                        â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ 6. Authorization request
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CARD NETWORK (Visa/Mastercard)                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  â€¢ Routes to issuing bank                                      â”‚
â”‚  â€¢ Applies network-level fraud detection                       â”‚
â”‚  â€¢ Manages authorization rules                                 â”‚
â”‚                        â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ 7. Authorization request
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ISSUING BANK (Customer's Bank)                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  â€¢ Checks customer's account balance                           â”‚
â”‚  â€¢ Verifies CVV                                                â”‚
â”‚  â€¢ Runs fraud detection                                        â”‚
â”‚  â€¢ Places hold on funds ($240)                                 â”‚
â”‚                                                                 â”‚
â”‚  Response: APPROVED or DECLINED                                â”‚
â”‚                        â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ 8. Authorization response
                         â”‚    flows back up the chain
                         â†“
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  Back to YOUR BACKEND   â”‚
             â”‚  Response:              â”‚
             â”‚  {                      â”‚
             â”‚    "status": "approved",â”‚
             â”‚    "pspReference":      â”‚
             â”‚      "8535...",         â”‚
             â”‚    "resultCode":        â”‚
             â”‚      "Authorised"       â”‚
             â”‚  }                      â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ 9. Update order status
                         â”‚    Save payment reference
                         â”‚    Send confirmation to customer
                         â†“
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚  Customer receives      â”‚
             â”‚  order confirmation     â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. PCI Compliance Breakdown

### 4.1 What's In PCI Scope vs Out of Scope

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  YOUR INFRASTRUCTURE (Minimal PCI Scope)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  âœ… OUT OF SCOPE (Safe - no card data):                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚  â€¢ Frontend HTML/JavaScript (loads Adyen components)           â”‚
â”‚  â€¢ Application servers (only receive tokens)                   â”‚
â”‚  â€¢ Database (stores tokens, not card numbers)                  â”‚
â”‚  â€¢ Order management system                                     â”‚
â”‚  â€¢ Customer records (with tokenized payment methods)           â”‚
â”‚                                                                 â”‚
â”‚  âš ï¸  MINIMAL SCOPE (Still need basic security):                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚  â€¢ HTTPS/TLS encryption (required)                             â”‚
â”‚  â€¢ Secure authentication                                       â”‚
â”‚  â€¢ Network firewalls                                           â”‚
â”‚  â€¢ Access controls                                             â”‚
â”‚  â€¢ Activity logging                                            â”‚
â”‚  â€¢ Vulnerability scanning (quarterly)                          â”‚
â”‚  â€¢ SAQ-A or SAQ-A-EP questionnaire (simplified)                â”‚
â”‚                                                                 â”‚
â”‚  âŒ NOT REQUIRED:                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚  â€¢ Card data encryption in database (no cards stored)          â”‚
â”‚  â€¢ Key management systems (no encryption keys needed)          â”‚
â”‚  â€¢ On-site PCI audits (for most merchants)                     â”‚
â”‚  â€¢ Extensive network segmentation                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ADYEN INFRASTRUCTURE (Full PCI Scope)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ğŸ”’ FULL PCI DSS LEVEL 1 COMPLIANCE:                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚  â€¢ Stores actual card numbers (encrypted)                      â”‚
â”‚  â€¢ Hardware Security Modules (HSM) for key management          â”‚
â”‚  â€¢ Tokenization vault                                          â”‚
â”‚  â€¢ Annual on-site audits by QSA                                â”‚
â”‚  â€¢ Extensive logging and monitoring                            â”‚
â”‚  â€¢ Network segmentation and DMZ                                â”‚
â”‚  â€¢ Physical security for data centers                          â”‚
â”‚  â€¢ Intrusion detection systems                                 â”‚
â”‚  â€¢ Regular penetration testing                                 â”‚
â”‚  â€¢ 24/7 security operations center                             â”‚
â”‚  â€¢ Incident response procedures                                â”‚
â”‚  â€¢ All 12 PCI DSS requirements                                 â”‚
â”‚                                                                 â”‚
â”‚  ğŸ’° Cost: Millions of dollars annually                         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 PCI Self-Assessment Questionnaire (SAQ) Types

When you use Adyen's hosted payment fields, you typically qualify for **SAQ-A** or **SAQ-A-EP**, the simplest questionnaires:

| SAQ Type | Requirements | Applies When |
|----------|--------------|--------------|
| **SAQ-A** | ~22 questions | Card data collected entirely on payment processor's website (full redirect) |
| **SAQ-A-EP** | ~160 questions | Card data collected in iframe/hosted fields on your website (Adyen Drop-in) |
| **SAQ-D** | ~300+ questions | You handle/store card data directly (avoid this!) |

---

## 5. Money Flow Diagram

### Who Gets Paid What & When

```
Day 1: Customer Makes Purchase
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Customer pays: $240.00
    â”‚
    â”‚ Authorization â†’ Funds on HOLD at Issuing Bank
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ISSUING BANK (Customer's Bank)              â”‚
â”‚  â€¢ Places $240 on hold                       â”‚
â”‚  â€¢ Funds still in customer's account         â”‚
â”‚  â€¢ Not yet transferred                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Day 2-3: Capture & Settlement (After you ship the order)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

You call Adyen: "Capture the payment"
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ISSUING BANK                                â”‚
â”‚  Transfers: $240.00                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
         Card Network
         (Interchange fees deducted)
               â”‚
               â”‚ Interchange Fee: ~$4.80 (2%)
               â”‚ Goes to Issuing Bank & Card Network
               â”‚
               â†“ Remaining: $235.20
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ACQUIRING BANK (Adyen's Bank)               â”‚
â”‚  Receives: $235.20                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
         Adyen takes payment processing fee
               â”‚
               â”‚ Adyen Fee: ~$0.70 + 0.5% = $1.90
               â”‚ (varies by contract)
               â”‚
               â†“ Remaining: $233.30
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  YOUR MERCHANT ACCOUNT                       â”‚
â”‚  Net Received: $233.30                       â”‚
â”‚  Arrives in: 2-7 business days               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Your business costs/profit
               â”‚
               â†“ (After fulfillment, shipping, etc.)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  YOUR BANK ACCOUNT                           â”‚
â”‚  Final deposit: $233.30                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.1 Fee Breakdown Example

For a **$240.00 purchase**:

```
Customer Pays:                                    $240.00
                                                  -------
Fees:
  â”œâ”€ Interchange Fee (Visa/MC):   ~2.0%         -$4.80
  â”œâ”€ Card Network Fee:             ~0.1%         -$0.24
  â”œâ”€ Acquiring Bank Fee:           ~0.1%         -$0.24
  â””â”€ Adyen Processing Fee:      $0.12 + 0.6%    -$1.56
                                                  -------
Net Settlement to You:                           $233.16
                                                  =======

Effective Fee Rate: 2.85%
```

**Note**: Actual fees vary based on:
- Card type (debit vs credit)
- Card brand (Visa, Mastercard, Amex)
- Business type (online vs in-store)
- Transaction volume (higher volume = lower rates)
- Your Adyen contract terms

### 5.2 Settlement Timeline

```
T+0 (Transaction Day)
â”‚
â”œâ”€ Order placed & authorized
â”œâ”€ Funds held at customer's bank
â”œâ”€ Order status: "Payment Authorized"
â”‚
T+1 (Next Day - After Shipping)
â”‚
â”œâ”€ You capture the payment via Adyen API
â”œâ”€ Settlement process begins
â”œâ”€ Order status: "Payment Captured"
â”‚
T+2 to T+7 (Settlement Period)
â”‚
â”œâ”€ Funds transfer through banking system
â”œâ”€ Fees deducted at each step
â”œâ”€ Order status: "Paid"
â”‚
T+7 (Typical Payout)
â”‚
â””â”€ Net amount appears in your bank account
   â””â”€ Ready to withdraw
```

---

## 6. Code Implementation Examples

### 6.1 Frontend: Adyen Drop-in Integration

```javascript
// checkout.html
<div id="adyen-checkout-container"></div>

<script src="https://checkoutshopper-live.adyen.com/checkoutshopper/sdk/5.52.0/adyen.js"></script>
<link rel="stylesheet" href="https://checkoutshopper-live.adyen.com/checkoutshopper/sdk/5.52.0/adyen.css">

<script>
// 1. Initialize Adyen when page loads
async function initializeCheckout() {
  // Get payment session from your backend
  const session = await fetch('/api/payment/session', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      cart_id: 'cart_123',
      amount: 24000, // in cents
      currency: 'USD'
    })
  }).then(r => r.json());

  // Create Adyen Drop-in component
  const configuration = {
    environment: 'live', // or 'test'
    clientKey: 'your_adyen_client_key',
    session: {
      id: session.id,
      sessionData: session.sessionData
    },
    onPaymentCompleted: (result, component) => {
      console.log('Payment completed:', result);
      if (result.resultCode === 'Authorised') {
        window.location.href = '/order-confirmation?id=' + result.merchantReference;
      }
    },
    onError: (error, component) => {
      console.error('Payment error:', error);
      alert('Payment failed: ' + error.message);
    },
    paymentMethodsConfiguration: {
      card: {
        hasHolderName: true,
        holderNameRequired: true,
        billingAddressRequired: true
      }
    }
  };

  const checkout = await AdyenCheckout(configuration);
  checkout.create('dropin').mount('#adyen-checkout-container');
}

initializeCheckout();
</script>
```

### 6.2 Backend: Order Creation with Validation

```javascript
// Node.js/Express example
const express = require('express');
const { Client, CheckoutAPI } = require('@adyen/api-library');

const app = express();

// Initialize Adyen client
const client = new Client({
  apiKey: process.env.ADYEN_API_KEY,
  environment: 'LIVE'
});
const checkout = new CheckoutAPI(client);

// Step 1: Create payment session (before user enters card)
app.post('/api/payment/session', async (req, res) => {
  const { cart_id, amount, currency } = req.body;

  // âœ… CRITICAL: Validate cart before creating session
  const validation = await validateCartAndInventory(cart_id);
  
  if (!validation.valid) {
    return res.status(400).json({
      error: 'Cart validation failed',
      details: validation.errors
    });
  }

  // Create Adyen session
  const session = await checkout.sessions({
    merchantAccount: process.env.ADYEN_MERCHANT_ACCOUNT,
    amount: { currency, value: amount },
    reference: `order_${Date.now()}`,
    returnUrl: `https://yoursite.com/payment-result`,
    countryCode: 'US'
  });

  res.json({
    id: session.id,
    sessionData: session.sessionData
  });
});

// Step 2: Handle payment result (webhook from Adyen)
app.post('/api/payment/webhook', async (req, res) => {
  const notification = req.body;

  // Verify webhook authenticity (important!)
  if (!verifyAdyenSignature(notification)) {
    return res.status(401).send('Invalid signature');
  }

  if (notification.eventCode === 'AUTHORISATION') {
    const orderId = notification.merchantReference;
    const success = notification.success;

    if (success) {
      // âœ… FINAL VALIDATION: Check inventory one last time
      const order = await getOrder(orderId);
      const inventoryCheck = await checkInventoryAvailability(order.items);

      if (!inventoryCheck.available) {
        // Inventory sold out during payment - cancel authorization
        await checkout.paymentsCancel({
          merchantAccount: process.env.ADYEN_MERCHANT_ACCOUNT,
          reference: notification.pspReference
        });

        await updateOrderStatus(orderId, 'cancelled_no_inventory');
        await notifyCustomer(order.customer_email, 'order_cancelled');

        return res.status(200).send('[accepted]');
      }

      // All validations passed - commit the order
      await commitInventory(order.items);
      await updateOrderStatus(orderId, 'paid');
      await sendOrderConfirmation(order.customer_email, orderId);
    } else {
      await updateOrderStatus(orderId, 'payment_failed');
    }
  }

  // Always return 200 to Adyen
  res.status(200).send('[accepted]');
});

// Helper: Validate cart with price and inventory checks
async function validateCartAndInventory(cart_id) {
  const cart = await getCart(cart_id);
  const errors = [];

  for (const item of cart.items) {
    // Check current price
    const currentProduct = await getProduct(item.sku);
    
    if (currentProduct.price !== item.price) {
      errors.push({
        sku: item.sku,
        error: 'price_changed',
        old_price: item.price,
        new_price: currentProduct.price
      });
    }

    // Check inventory
    if (currentProduct.inventory < item.quantity) {
      errors.push({
        sku: item.sku,
        error: 'insufficient_inventory',
        requested: item.quantity,
        available: currentProduct.inventory
      });
    }
  }

  return {
    valid: errors.length === 0,
    errors
  };
}

// Helper: Reserve inventory (temporary hold)
async function reserveInventory(items, duration_minutes = 15) {
  const reservation_id = generateId();
  const expires_at = new Date(Date.now() + duration_minutes * 60000);

  // Use database transaction to ensure atomicity
  await db.transaction(async (trx) => {
    for (const item of items) {
      // Check and decrement available inventory
      const updated = await trx('inventory')
        .where('sku', item.sku)
        .where('available', '>=', item.quantity)
        .decrement('available', item.quantity)
        .increment('reserved', item.quantity);

      if (updated === 0) {
        throw new Error(`Insufficient inventory for ${item.sku}`);
      }

      // Create reservation record
      await trx('inventory_reservations').insert({
        reservation_id,
        sku: item.sku,
        quantity: item.quantity,
        expires_at
      });
    }
  });

  return { reservation_id, expires_at };
}

// Helper: Commit inventory (finalize sale)
async function commitInventory(items, reservation_id) {
  await db.transaction(async (trx) => {
    for (const item of items) {
      // Move from reserved to sold
      await trx('inventory')
        .where('sku', item.sku)
        .decrement('reserved', item.quantity);
    }

    // Delete reservation
    await trx('inventory_reservations')
      .where('reservation_id', reservation_id)
      .delete();
  });
}

app.listen(3000);
```

### 6.3 Database Schema

```sql
-- Products table
CREATE TABLE products (
  sku VARCHAR(50) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  price DECIMAL(10, 2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'USD',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Inventory table
CREATE TABLE inventory (
  sku VARCHAR(50) PRIMARY KEY,
  total INT NOT NULL DEFAULT 0,
  available INT NOT NULL DEFAULT 0,  -- Available for purchase
  reserved INT NOT NULL DEFAULT 0,   -- Temporarily held during checkout
  sold INT NOT NULL DEFAULT 0,       -- Committed sales
  FOREIGN KEY (sku) REFERENCES products(sku),
  CHECK (available >= 0),
  CHECK (total = available + reserved + sold)
);

-- Inventory reservations (temporary holds)
CREATE TABLE inventory_reservations (
  id INT AUTO_INCREMENT PRIMARY KEY,
  reservation_id VARCHAR(50) NOT NULL,
  sku VARCHAR(50) NOT NULL,
  quantity INT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP NOT NULL,
  FOREIGN KEY (sku) REFERENCES products(sku),
  INDEX idx_expires (expires_at)
);

-- Orders table
CREATE TABLE orders (
  id INT AUTO_INCREMENT PRIMARY KEY,
  order_number VARCHAR(50) UNIQUE NOT NULL,
  customer_email VARCHAR(255) NOT NULL,
  total_amount DECIMAL(10, 2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'USD',
  status ENUM('pending', 'authorized', 'paid', 'shipped', 'cancelled') DEFAULT 'pending',
  payment_token VARCHAR(255),           -- âœ… Safe: Adyen token, not card number
  payment_reference VARCHAR(255),       -- Adyen PSP reference
  reservation_id VARCHAR(50),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Order items
CREATE TABLE order_items (
  id INT AUTO_INCREMENT PRIMARY KEY,
  order_id INT NOT NULL,
  sku VARCHAR(50) NOT NULL,
  quantity INT NOT NULL,
  price_at_purchase DECIMAL(10, 2) NOT NULL,  -- Price when ordered
  FOREIGN KEY (order_id) REFERENCES orders(id),
  FOREIGN KEY (sku) REFERENCES products(sku)
);

-- Background job to clean expired reservations
-- Run every 5 minutes
CREATE EVENT cleanup_expired_reservations
ON SCHEDULE EVERY 5 MINUTE
DO
  BEGIN
    -- Release expired reservations back to available inventory
    UPDATE inventory i
    INNER JOIN inventory_reservations r ON i.sku = r.sku
    SET i.available = i.available + r.quantity,
        i.reserved = i.reserved - r.quantity
    WHERE r.expires_at < NOW();
    
    -- Delete expired reservation records
    DELETE FROM inventory_reservations
    WHERE expires_at < NOW();
  END;
```

---

## 7. Key Security & Best Practices

### âœ… DO's

1. **Always use HTTPS** - No exceptions for payment pages
2. **Validate on backend** - Never trust frontend validation alone
3. **Re-check before payment** - Prices and inventory can change
4. **Use atomic transactions** - Prevent race conditions with database locks
5. **Reserve inventory** - Hold items during checkout (with expiration)
6. **Log everything** - Payment attempts, validation failures, inventory changes
7. **Handle webhooks properly** - Verify signatures, return 200 immediately
8. **Test failure scenarios** - Out of stock, price changes, payment declines
9. **Use idempotency keys** - Prevent duplicate charges
10. **Monitor for fraud** - Unusual order patterns, velocity checks

### âŒ DON'Ts

1. **Never store card numbers** - Use tokens only
2. **Don't skip final validation** - Even if checked earlier
3. **Don't trust cart prices from frontend** - Always verify on backend
4. **Don't process without inventory** - Overselling creates customer issues
5. **Don't expose internal IDs** - Use UUIDs for order numbers
6. **Don't ignore webhook failures** - Implement retry logic
7. **Don't handle card data** - Let Adyen's iframe do it
8. **Don't commit inventory on auth** - Wait for capture
9. **Don't show detailed error messages** - Avoid helping attackers
10. **Don't skip testing** - Payment bugs are expensive

---

## 8. Summary

### Flow Recap

```
1. User adds items to cart â†’ Stores cart with prices at that moment
2. User clicks checkout â†’ âœ… Validate prices and inventory (First check)
3. If valid â†’ Reserve inventory temporarily (10-15 min hold)
4. User enters payment (via Adyen iframe) â†’ Card data never touches your server
5. User submits â†’ âœ… Re-validate prices and inventory (Final check)
6. If still valid â†’ Process payment with Adyen
7. Payment authorized â†’ âœ… Commit inventory (move from reserved to sold)
8. Adyen webhook confirms â†’ Update order status, send confirmation
9. Settlement (2-7 days later) â†’ Funds arrive in your bank account
```

### PCI Compliance Summary

- **Your scope**: Minimal (SAQ-A-EP) - just basic security hygiene
- **Adyen's scope**: Full (Level 1) - they handle all card data
- **Key principle**: Card data never touches your systems

### Money Flow Summary

```
Customer pays $240
  â†“
- Interchange fees (~$5)
- Card network fees (~$0.25)
- Adyen fees (~$2)
  â†“
You receive ~$233 (97% of transaction)
```

---

## Additional Resources

- **Adyen Documentation**: https://docs.adyen.com/
- **PCI Security Standards**: https://www.pcisecuritystandards.org/
- **Payment Flow Testing**: Use Adyen's test cards in test environment
- **Webhook Testing**: Use tools like ngrok for local testing

---

**Document Version**: 1.0  
**Last Updated**: November 12, 2025  
**Author**: Checkout Architecture Documentation

